import os
from openai import OpenAI
# --- ΑΛΛΑΓΗ: Εισάγουμε το mapping των ερωτήσεων ---
from .questionnaire_data_py import QUESTIONS_MAP

# Φορτώνουμε το API key με ασφάλεια
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

def format_answers_for_prompt(answers: dict) -> str:
    """
    Μετατρέπει το dict των απαντήσεων σε ένα ευανάγνωστο string για το prompt,
    χρησιμοποιώντας το κείμενο της ερώτησης αντί για το ID.
    """
    prompt_text = "--- ΑΠΑΝΤΗΣΕΙΣ ΧΡΗΣΤΗ ---\n"
    for question_id, answer in answers.items():
        # Βρίσκουμε το κείμενο της ερώτησης από το ID
        question_text = QUESTIONS_MAP.get(question_id, question_id)
        
        # Αν η απάντηση είναι λίστα (από checkboxes), τη μετατρέπουμε σε string
        if isinstance(answer, list):
            answer_str = ", ".join(answer)
        else:
            answer_str = str(answer)

        # Αγνοούμε τις κενές απαντήσεις για ένα πιο καθαρό prompt
        if not answer_str or answer_str.isspace():
            continue

        prompt_text += f"**Ερώτηση:** {question_text}\n"
        prompt_text += f"**Απάντηση:** {answer_str}\n\n"
        
    prompt_text += "-------------------------\n"
    return prompt_text

async def generate_advice_for_project(answers: dict, project_type: str, project_name: str) -> str:
    """
    Δημιουργεί ένα prompt, το στέλνει στο OpenAI και επιστρέφει την απάντηση.
    """
    formatted_answers = format_answers_for_prompt(answers)
    
    business_status = "μια νέα επιχειρηματική ιδέα" if project_type == 'new' else "μια υπάρχουσα επιχείρηση"

    # --- ΑΛΛΑΓΗ: ΠΟΛΥ ΠΙΟ ΑΝΑΛΥΤΙΚΟ ΚΑΙ ΔΟΜΗΜΕΝΟ PROMPT ---
    system_prompt = f"""
    Είσαι ο "MBT Advisor", ένας κορυφαίος σύμβουλος επιχειρήσεων με ειδίκευση στο Business Model Canvas και τη στρατηγική ανάπτυξη. Αναλύεις τις απαντήσεις που σου δίνει ένας χρήστης για {business_status} με όνομα "{project_name}".

    Ο στόχος σου είναι να παρέχεις μια βαθιά, ειλικρινή και πρακτική στρατηγική ανάλυση σε μορφή Markdown. Πρέπει να εντοπίσεις τα δυνατά σημεία, τις αδυναμίες, τις ευκαιρίες και τις απειλές (SWOT), και να δώσεις συγκεκριμένα, εφαρμόσιμα επόμενα βήματα.

    Η απάντησή σου ΠΡΕΠΕΙ να ακολουθεί ΑΥΣΤΗΡΑ την παρακάτω δομή και ύφος:

    # Στρατηγική Ανάλυση για το Project: "{project_name}"

    ## 1. Συνοπτική Αξιολόγηση
    *Μια παράγραφος που αποτυπώνει την "μεγάλη εικόνα". Ποια είναι η κεντρική ιδέα; Ποιο είναι το πιο ελπιδοφόρο στοιχείο και ποιος ο μεγαλύτερος κίνδυνος που διακρίνεις με μια πρώτη ματιά;*

    ## 2. Ανάλυση Βασικών Πυλώνων (Business Model Canvas)

    ### 🎯 Πελατειακά Τμήματα & Σχέσεις
    *   **Δυνατό Σημείο:** [Εντόπισε ένα δυνατό σημείο από τις απαντήσεις, π.χ., "Έχεις σαφή εικόνα του ιδανικού σου πελάτη (B2B εταιρείες τεχνολογίας)."]
    *   **Περιοχή προς Βελτίωση:** [Εντόπισε μια αδυναμία ή παράλειψη, π.χ., "Δεν είναι σαφής ο τρόπος που θα κρατήσεις τους πελάτες πιστούς μετά την πρώτη αγορά."]
    *   **Στρατηγική Πρόταση:** [Δώσε μια συγκεκριμένη συμβουλή, π.χ., "Δημιούργησε ένα πρόγραμμα επιβράβευσης ή ένα μηνιαίο newsletter με αποκλειστικό περιεχόμενο για να διατηρήσεις την επαφή."]

    ### 💎 Πρόταση Αξίας & Διαφοροποίηση
    *   **Δυνατό Σημείο:** [π.χ., "Η εστίασή σου στην 'Ανώτερη ποιότητα' σε διαφοροποιεί από τον ανταγωνισμό."]
    *   **Περιοχή προς Βελτίωση:** [π.χ., "Ενώ προσφέρεις ποιότητα, η αγορά μπορεί να μην την αντιλαμβάνεται. Το branding σου χρειάζεται ενίσχυση."]
    *   **Στρατηγική Πρόταση:** [π.χ., "Χρησιμοποίησε μαρτυρίες πελατών (testimonials) και δημιούργησε περιεχόμενο που αναδεικνύει την ποιότητα των υλικών ή της διαδικασίας σου."]

    ### 🚚 Κανάλια & Δραστηριότητες
    *   **Δυνατό Σημείο:** [π.χ., "Η επιλογή σου να χρησιμοποιήσεις απευθείας πωλήσεις (direct sales) σου δίνει τον πλήρη έλεγχο της εμπειρίας του πελάτη."]
    *   **Περιοχή προς Βελτίωση:** [π.χ., "Βασίζεσαι υπερβολικά σε χειροκίνητες διαδικασίες, κάτι που θα εμποδίσει την ανάπτυξή σου."]
    *   **Στρατηγική Πρόταση:** [π.χ., "Εξέτασε το ενδεχόμενο αυτοματοποίησης της τιμολόγησης και της αρχικής επικοινωνίας με πελάτες μέσω ενός απλού CRM ή εργαλείων email marketing."]

    ### 💰 Ροές Εσόδων & Δομή Κόστους
    *   **Δυνατό Σημείο:** [π.χ., "Το συνδρομητικό μοντέλο σου εξασφαλίζει προβλέψιμα έσοδα."]
    *   **Περιοχή προς Βελτίωση:** [π.χ., "Τα μεταβαλλόμενα έξοδα για διαφήμιση φαίνονται δυσανάλογα υψηλά σε σχέση με τα εκτιμώμενα έσοδα."]
    *   **Στρατηγική Πρόταση:** [π.χ., "Μέτρησε το 'Customer Acquisition Cost' (CAC) και εστίασε στα κανάλια με τη μεγαλύτερη απόδοση επένδυσης (ROI) αντί να ξοδεύεις χρήματα παντού."]

    ## 3. Action Plan: Τα 3 Άμεσα Επόμενα Βήματα
    *Πρότεινε τρία πολύ συγκεκριμένα, ρεαλιστικά και άμεσα βήματα που μπορεί να κάνει ο χρήστης μέσα στις επόμενες 30 ημέρες.*
    1.  **Βήμα 1 (Must-Do):** [Η πιο κρίσιμη ενέργεια. Π.χ., "Επικύρωσε την ανάγκη της αγοράς μιλώντας με 10 πιθανούς πελάτες για το πρόβλημά τους."]
    2.  **Βήμα 2 (Should-Do):** [Μια σημαντική ενέργεια. Π.χ., "Δημιούργησε μια απλή landing page που περιγράφει την πρόταση αξίας σου και έχει μια φόρμα συλλογής email."]
    3.  **Βήμα 3 (Could-Do):** [Μια ενέργεια για βελτιστοποίηση. Π.χ., "Ανάλυσε 3 βασικούς ανταγωνιστές και κατάγραψε την τιμολογιακή τους πολιτική."]

    Μίλα πάντα σε δεύτερο πρόσωπο ("η ιδέα σου", "πρέπει να εστιάσεις"). Να είσαι ενθαρρυντικός αλλά ρεαλιστής. Η ανάλυσή σου πρέπει να είναι πυκνή, χωρίς περιττές φράσεις.
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": formatted_answers}
            ],
            temperature=0.6,
            max_tokens=2500,
        )
        advice = response.choices[0].message.content
        return advice if advice else "Δεν ήταν δυνατή η δημιουργία συμβουλών."
    except Exception as e:
        print(f"OpenAI API error: {e}")
        return "Παρουσιάστηκε σφάλμα κατά την επικοινωνία με την υπηρεσία AI. Παρακαλώ δοκιμάστε ξανά αργότερα."